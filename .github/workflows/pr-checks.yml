name: Pull Request Checks

on:
  pull_request:
    branches: ['main', 'develop']

jobs:
  pr-checks:
    runs-on: ubuntu-latest
    name: PR Quality Checks

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint with annotations
        run: |
          npm run lint -- --format=@eslint/eslintrc --output-file=eslint-report.json
        continue-on-error: true

      - name: Check code formatting
        run: |
          if ! npm run format:check; then
            echo "❌ Code formatting issues found!"
            echo "Run 'npm run format' to fix formatting issues."
            exit 1
          else
            echo "✅ Code formatting is correct!"
          fi

      - name: Run tests with coverage
        run: npm run test:coverage
        continue-on-error: true

      - name: Build application
        run: |
          if npm run build; then
            echo "✅ Build successful!"
          else
            echo "❌ Build failed!"
            exit 1
          fi

      - name: Check bundle size
        run: |
          if [ -d "dist" ]; then
            echo "📦 Bundle Analysis:"
            echo "Total bundle size:"
            du -sh dist/
            echo ""
            echo "Asset breakdown:"
            find dist -name "*.js" -o -name "*.css" | head -10 | xargs ls -lh
          fi

      - name: PR Summary
        if: always()
        run: |
          echo "## 📋 Pull Request Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ✅ Completed Checks" >> $GITHUB_STEP_SUMMARY
          echo "- Code linting" >> $GITHUB_STEP_SUMMARY
          echo "- Code formatting" >> $GITHUB_STEP_SUMMARY
          echo "- Unit tests" >> $GITHUB_STEP_SUMMARY
          echo "- Build verification" >> $GITHUB_STEP_SUMMARY
          echo "- Bundle size analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 🚀 Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "If all checks pass, this PR is ready for review and merge!" >> $GITHUB_STEP_SUMMARY
